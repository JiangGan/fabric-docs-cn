<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>概览与入门 &mdash; Fabric-docs-cn 1.8 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Fabric-docs-cn 1.8 documentation" href="index.html" />
    <link rel="next" title="The environment dictionary, env" href="usage/env.html" />
    <link rel="prev" title="欢迎访问 Fabric 中文版文档！" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="usage/env.html" title="The environment dictionary, env"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="欢迎访问 Fabric 中文版文档！"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Fabric-docs-cn 1.8 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>概览与入门<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>欢迎来到 Fabric！</p>
<p>本文档走马观花式地介绍 Fabric 特性，也是对其使用的快速指导。其他文档（这里通篇的链接都指向它们）可以在 <a class="reference internal" href="index.html#usage-docs"><em>用法文档</em></a> 里找到——请不要忘记也看看它们。</p>
<div class="section" id="fabric">
<h2>Fabric 是什么？<a class="headerlink" href="#fabric" title="Permalink to this headline">¶</a></h2>
<p>正如 <tt class="docutils literal"><span class="pre">README</span></tt> 所说：</p>
<blockquote>
<div>Fabric 是一个 Python (2.5-2.7) 库和命令行工具，用来流水线化执行 SSH 以部署应用或系统管理任务。</div></blockquote>
<p>更具体地说，Fabric 是：</p>
<ul class="simple">
<li>一个让你通过 <strong>命令行</strong> 执行 <strong>任意 Python 函数</strong> 的工具；</li>
<li>一个让通过 SSH 执行 Shell 命令更加 <strong>容易</strong> 和 <strong>蟒样</strong> 的子程序库（建立于一个更低层次的库）。</li>
</ul>
<p>自然地，大部分用户把这两件事结合着用，使用 Fabric 来写和执行 Python 函数或 <strong>任务</strong> ，以实现与远程服务器的自动化交互。让我们先睹为快吧。</p>
</div>
<div class="section" id="fab">
<h2>你好， <tt class="docutils literal"><span class="pre">fab</span></tt><a class="headerlink" href="#fab" title="Permalink to this headline">¶</a></h2>
<p>如果没有下面这个国际惯例，这个文档恐怕不能算是个合格的入门指导:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello world!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>把上述代码放在你当前的工作目录中一个名为 <tt class="docutils literal"><span class="pre">fabfile.py</span></tt> 的 Python 模块文件中。然后这个 <tt class="docutils literal"><span class="pre">hello</span></tt> 函数就可以用安装 Fabric 时顺便装上的 <tt class="docutils literal"><span class="pre">fab</span></tt> 工具来执行了，它将如你所料地工作:</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab hello
Hello world!

Done.
</pre></div>
</div>
<p>这就是这个模块的所有作用。这个功能让 Fabric 可以作为一个极其基本的构建工具来使用，简单到甚至不用导入它的任何 API。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这个 <tt class="docutils literal"><span class="pre">fab</span></tt> 简单地导入了你的 fabfile 并执行你定义的一个或多个函数。这里并没有任何魔术——任何你能在一个普通 Python 模块中做的事情都同样可以在一个 fabfile 中完成。</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="usage/execution.html#execution-strategy"><em>Execution strategy</em></a>, <a class="reference internal" href="usage/tasks.html"><em>Defining tasks</em></a>, <a class="reference internal" href="usage/fab.html"><em>fab options and arguments</em></a></p>
</div>
</div>
<div class="section" id="id2">
<h2>任务参数<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>就像你在常规的 Python 编程中那样，在执行任务时传递一些运行时参数经常能帮上大忙。Fabric 支持用兼容 Shell 的参数用法： <tt class="docutils literal"><span class="pre">&lt;任务名&gt;:&lt;参数&gt;,</span> <span class="pre">&lt;关键字参数名&gt;=&lt;参数值&gt;,...</span></tt> 虽然有点勉强，但可以扩展上面的例子，让它只向你 say hello:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;world&quot;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello </span><span class="si">%s</span><span class="s">!&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>默认情况下，调用 <tt class="docutils literal"><span class="pre">fab</span> <span class="pre">hello</span></tt> 仍然会像之前那样工作，但现在我们可以做些个性化定制了:</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab hello:name=Jeff
Hello Jeff!

Done.
</pre></div>
</div>
<p>用过 Python 编程的同学可能已经猜到了，这样调用也是完全一样的:</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab hello:Jeff
Hello Jeff!

Done.
</pre></div>
</div>
<p>目前，参数值只能作为 Python 字符串来使用，如果要使用复杂类型，例如列表，会需要一些字符串操作处理。将来的版本可能会添加一个类型转换系统，以简化这类处理。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="usage/fab.html#task-arguments"><em>Per-task arguments</em></a></p>
</div>
</div>
<div class="section" id="id3">
<h2>本地命令<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>在前面的例子中， <tt class="docutils literal"><span class="pre">fab</span></tt> 实际上只节省了数行 <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">&quot;__main__&quot;</span></tt> 这样的固定样板代码而已。Fabric 更多地被设计为使用它自己的 API，它们包括执行 Shell 命令、传送文件等等的函数（或 <strong>操作</strong> ）。</p>
<p>我们以一个 Web 应用为例来创建一个 fabfile。具体的情景如下：这个 Web 应用用一台远程服务器 <tt class="docutils literal"><span class="pre">vcshost</span></tt> 上的 Git 管理代码，我们把它的代码库克隆到了本地 <tt class="docutils literal"><span class="pre">localhost</span></tt> 中。当我们把修改后的代码 push 回 <tt class="docutils literal"><span class="pre">vcshost</span></tt> 的时候，我们想自动就立即把新的版本安装到另一台远程服务器 <tt class="docutils literal"><span class="pre">my_server</span></tt> 上。我们将用自动化的本地和远程 Git 命令来完成这些工作。</p>
<p>fabfile 文件最好放在一个项目的根目录:</p>
<div class="highlight-python"><div class="highlight"><pre>.
|-- __init__.py
|-- app.wsgi
|-- fabfile.py &lt;-- our fabfile!
|-- manage.py
`-- my_app
    |-- __init__.py
    |-- models.py
    |-- templates
    |   `-- index.html
    |-- tests.py
    |-- urls.py
    `-- views.py
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">我们在这里用的是一个 Django 应用，但这仅仅是个例子——Fabric 并未与任何外部代码绑定，除了它的 SSH 库。</p>
</div>
<p>作为起步，可能我们希望先执行测试，然后再提交到 VCS（版本控制系统），为部署作好准备:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">local</span>

<span class="k">def</span> <span class="nf">prepare_deploy</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;./manage.py test my_app&quot;</span><span class="p">)</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;git add -p &amp;&amp; git commit&quot;</span><span class="p">)</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;git push&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>这段代码的输出会是这样:</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab prepare_deploy
[localhost] run: ./manage.py test my_app
Creating test database...
Creating tables
Creating indexes
..........................................
----------------------------------------------------------------------
Ran 42 tests in 9.138s

OK
Destroying test database...

[localhost] run: git add -p &amp;&amp; git commit

&lt;interactive Git add / git commit edit message session&gt;

[localhost] run: git push

&lt;git push session, possibly merging conflicts interactively&gt;

Done.
</pre></div>
</div>
<p>这段代码很简单，导入一个 Fabric API： <cite>~fabric.operations.local</cite> ，然后用它执行本地 Shell 命令并与之交互，剩下的 Fabric API 也是类似的——它们都只是 Python 而已。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="api/core/operations.html"><em>Operations</em></a>, <a class="reference internal" href="usage/fabfiles.html#fabfile-discovery"><em>Fabfile discovery</em></a></p>
</div>
</div>
<div class="section" id="id4">
<h2>用你的方式来组织<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>因为 Fabric“只是 Python”，你可以以你想要的任何方式来组织你的 fabfile。例如，把任务分割成多个子任务:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">local</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;./manage.py test my_app&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">commit</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;git add -p &amp;&amp; git commit&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">push</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;git push&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prepare_deploy</span><span class="p">():</span>
    <span class="n">test</span><span class="p">()</span>
    <span class="n">commit</span><span class="p">()</span>
    <span class="n">push</span><span class="p">()</span>
</pre></div>
</div>
<p>这个 <tt class="docutils literal"><span class="pre">prepare_deploy</span></tt> 任务仍可以像之前那样调用，但现在只要你想，就可以调用更细粒度的子任务了。</p>
</div>
<div class="section" id="id5">
<h2>故障<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>我们的基本案例已经可以正常工作了，但如果测试失败了会发生什么事？没准我们想来个急刹车，并在部署之前修复这些失败的测试。</p>
<p>Fabric 会检查被调用程序的返回值，如果这些程序没有干净地退出，Fabric 会放弃操作。下面我们就来看看如果一个测试用例遇到错误时会发生什么事:</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab prepare_deploy
[localhost] run: ./manage.py test my_app
Creating test database...
Creating tables
Creating indexes
.............E............................
======================================================================
ERROR: testSomething (my_project.my_app.tests.MainTests)
----------------------------------------------------------------------
Traceback (most recent call last):
[...]

----------------------------------------------------------------------
Ran 42 tests in 9.138s

FAILED (errors=1)
Destroying test database...

Fatal error: local() encountered an error (return code 2) while executing &#39;./manage.py test my_app&#39;

Aborting.
</pre></div>
</div>
<p>太好了！我们什么都不用做，Fabric 检测到了错误并放弃了操作，不会继续执行 <tt class="docutils literal"><span class="pre">commit</span></tt> 任务。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="usage/execution.html#failures"><em>故障处理（用法文档）</em></a></p>
</div>
<div class="section" id="id6">
<h3>故障处理<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>但如果我们想更加灵活，给用户另一个选择，又该怎么办呢？一个名为 <a class="reference internal" href="usage/env.html#warn-only"><em>warn_only</em></a> 的设置（或 <strong>环境变量</strong> ，经常缩写为 <strong>env var</strong> ）可以把放弃变成警告，使得灵活处理错误成为现实。</p>
<p>让我们把这个设置丢到我们的 <tt class="docutils literal"><span class="pre">test</span></tt> 函数中，然后看看这个 <cite>~fabric.operations.local</cite> 调用的结果如何:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">local</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.console</span> <span class="kn">import</span> <span class="n">confirm</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;./manage.py test my_app&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">failed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span><span class="s">&quot;Tests failed. Continue anyway?&quot;</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="s">&quot;Aborting at user request.&quot;</span><span class="p">)</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>在添加这个新特性时，我们引入了一些新东西：</p>
<ul class="simple">
<li>在 Python 2.5 中，需要导入 <tt class="docutils literal"><span class="pre">__future__</span></tt> 才能使用 <tt class="docutils literal"><span class="pre">with</span></tt> ；</li>
<li>Fabric 的 <cite>contrib.console &lt;fabric.contrib.console&gt;</cite> 子模块包含了 <cite>~fabric.contrib.console.confirm</cite> 函数，用来做简单的 yes/no 提示；</li>
<li>上下文管理器 <cite>~fabric.context_managers.settings</cite> 用来将设置应用到某个特定的代码块中；</li>
<li>运行命令的操作，如 <cite>~fabric.operations.local</cite> ，可以返回一个包含该操作的结果信息（例如 <tt class="docutils literal"><span class="pre">.failed</span></tt> 或 <tt class="docutils literal"><span class="pre">.return_code</span></tt> ）的对象；</li>
<li>还有 <cite>~fabric.utils.abort</cite> 函数，可以用来手工取消执行。</li>
</ul>
<p>然而，即使在增加了上述复杂度之后，整个处理过程仍然很容易理解，而且它已经远比之前灵活了。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="api/core/context_managers.html"><em>Context Managers</em></a>, <a class="reference internal" href="usage/env.html#env-vars"><em>Full list of env vars</em></a></p>
</div>
</div>
</div>
<div class="section" id="id7">
<h2>建立连接<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>我们开始让 fabfile 回到主旨吧：定义一个 <tt class="docutils literal"><span class="pre">deploy</span></tt> 任务，让它在一台或多台远程服务器上运行，并保证代码是最新的:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="n">code_dir</span> <span class="o">=</span> <span class="s">&#39;/srv/django/myproject&#39;</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">code_dir</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&quot;git pull&quot;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&quot;touch app.wsgi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>这里再次引入了一些新的概念：</p>
<ul class="simple">
<li>Fabric 就是 Python——所以我们可以自由地使用变量、字符串等常规的 Python 代码结构；</li>
<li><cite>~fabric.context_managers.cd</cite> 是一个很方便的前缀命令，相当于执行 <tt class="docutils literal"><span class="pre">cd</span> <span class="pre">/to/some/directory</span></tt> 命令，这个命令和 <cite>~fabric.context_managers.lcd</cite> 一样，不过后者针对本地；</li>
<li><cite>~fabric.operations.run</cite> 则和 <cite>~fabric.operations.local</cite> 类似，但它是运行 <strong>远程</strong> 命令而非本地。</li>
</ul>
<p>我们还需要确认在文件顶部导入了新的函数:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">local</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">cd</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.console</span> <span class="kn">import</span> <span class="n">confirm</span>
</pre></div>
</div>
<p>改好之后，我们再来部署:</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab deploy
No hosts found. Please specify (single) host string for connection: my_server
[my_server] run: git pull
[my_server] out: Already up-to-date.
[my_server] out:
[my_server] run: touch app.wsgi

Done.
</pre></div>
</div>
<p>我们从来没有在 fabfile 中指定任何连接信息，所以 Fabric 不知道该在哪里运行那些远程命令。当遇到这种情况，Fabric 会在运行时提示我们。连接的定义使用 SSH 风格的“主机串”（例如： <tt class="docutils literal"><span class="pre">user&#64;host:port</span></tt> ），默认使用你的本地用户名——所以在这个例子中，我们只需要指定主机名 <tt class="docutils literal"><span class="pre">my_server</span></tt> 。</p>
<div class="section" id="id8">
<h3>远程交互<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>如果你已经签出过代码， <tt class="docutils literal"><span class="pre">git</span> <span class="pre">pull</span></tt> 就能很好地工作——但如果这是第一次部署呢？如果还能用 <tt class="docutils literal"><span class="pre">git</span> <span class="pre">clone</span></tt> 来处理这种情况那才叫棒呢:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="n">code_dir</span> <span class="o">=</span> <span class="s">&#39;/srv/django/myproject&#39;</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;test -d </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code_dir</span><span class="p">)</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&quot;git clone user@vcshost:/path/to/repo/.git </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code_dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">code_dir</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&quot;git pull&quot;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&quot;touch app.wsgi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>就像我们上面调用 <cite>~fabric.operations.local</cite> 一样， <cite>~fabric.operations.run</cite> 也让我们基于 Shell 命令构建干净的 Python 层逻辑。然后这里最有趣的部分是 <tt class="docutils literal"><span class="pre">git</span> <span class="pre">clone</span></tt> ：因为我们是用 Git 的 SSH 方法来访问 Git 服务器上的代码库，这意味着我们的远程 <cite>~fabric.operations.run</cite> 调用本身需要身份验证。</p>
<p>旧版本的 Fabric（和其他类似的高层次 SSH 库）像在监狱里一样运行远程命令，无法在本地交互。当你很迫切需要输入密码或与远程程序交互时，这就很成问题。</p>
<p>Fabric 1.0 和后续的版本突破了这个限制，并保证你总是能和另一边对话。让我们看看当我们在一台没有 Git checkout 的新服务器上运行更新后的 <tt class="docutils literal"><span class="pre">deploy</span></tt> 任务时会发生什么:</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab deploy
No hosts found. Please specify (single) host string for connection: my_server
[my_server] run: test -d /srv/django/myproject

Warning: run() encountered an error (return code 1) while executing &#39;test -d /srv/django/myproject&#39;

[my_server] run: git clone user@vcshost:/path/to/repo/.git /srv/django/myproject
[my_server] out: Cloning into /srv/django/myproject...
[my_server] out: Password: &lt;enter password&gt;
[my_server] out: remote: Counting objects: 6698, done.
[my_server] out: remote: Compressing objects: 100% (2237/2237), done.
[my_server] out: remote: Total 6698 (delta 4633), reused 6414 (delta 4412)
[my_server] out: Receiving objects: 100% (6698/6698), 1.28 MiB, done.
[my_server] out: Resolving deltas: 100% (4633/4633), done.
[my_server] out:
[my_server] run: git pull
[my_server] out: Already up-to-date.
[my_server] out:
[my_server] run: touch app.wsgi

Done.
</pre></div>
</div>
<p>注意那个 <tt class="docutils literal"><span class="pre">Password:</span></tt> 提示——那就是我们在 Web 服务器上的远程 <tt class="docutils literal"><span class="pre">git</span></tt> 调用在询问 Git 密码。我们可以在里面输入密码，然后像往常一样继续克隆。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="usage/interactivity.html"><em>Interaction with remote programs</em></a></p>
</div>
</div>
<div class="section" id="defining-connections">
<span id="id9"></span><h3>预先定义连接<a class="headerlink" href="#defining-connections" title="Permalink to this headline">¶</a></h3>
<p>在运行时输入连接信息已经落后太多了，所以 Fabric 提供了一种方便的办法，在你的 fabfile 或命令行中指定。我们不打算在这里完全展开来说，但我们会向你展示最常用的：设置全局主机列表 <a class="reference internal" href="usage/env.html#hosts"><em>env.hosts</em></a> 。</p>
<p><a class="reference internal" href="usage/env.html"><em>env</em></a> 是一个全局的类字典对象，驱动着 Fabric 的大部分设置，而且可以带着属性写进去（事实上，前面见过的 <cite>~fabric.context_managers.settings</cite> 是它的一个简单包装）。因此，我们可以在模块层次上，在 fabfile 的顶部附近修改它，就像这样:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.console</span> <span class="kn">import</span> <span class="n">confirm</span>

<span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;my_server&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">do_test_stuff</span><span class="p">()</span>
</pre></div>
</div>
<p>当 <tt class="docutils literal"><span class="pre">fab</span></tt> 加载我们的 fabfile 时，我们对 <tt class="docutils literal"><span class="pre">env</span></tt> 的修改将被执行，并保存为对设置的修改。最终的结果就如上面所示：我们的 <tt class="docutils literal"><span class="pre">deploy</span></tt> 任务将在 <tt class="docutils literal"><span class="pre">my_server</span></tt> 上运行。</p>
<p>这也是你如何告诉 Fabric 一次在多台远程服务器上运行的方法：因为 <tt class="docutils literal"><span class="pre">env.hosts</span></tt> 是一个列表， <tt class="docutils literal"><span class="pre">fab</span></tt> 对它进行迭代，为每个连接调用指定的任务。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="usage/env.html"><em>The environment dictionary, env</em></a>, <a class="reference internal" href="usage/execution.html#host-lists"><em>How host lists are constructed</em></a></p>
</div>
</div>
</div>
<div class="section" id="id10">
<h2>小结<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>在经过了这么多，我们的完整的 fabfile 文件仍然相当短。下面是它的完整内容:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.console</span> <span class="kn">import</span> <span class="n">confirm</span>

<span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;my_server&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;./manage.py test my_app&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">failed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">confirm</span><span class="p">(</span><span class="s">&quot;Tests failed. Continue anyway?&quot;</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="s">&quot;Aborting at user request.&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">commit</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;git add -p &amp;&amp; git commit&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">push</span><span class="p">():</span>
    <span class="n">local</span><span class="p">(</span><span class="s">&quot;git push&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prepare_deploy</span><span class="p">():</span>
    <span class="n">test</span><span class="p">()</span>
    <span class="n">commit</span><span class="p">()</span>
    <span class="n">push</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
    <span class="n">code_dir</span> <span class="o">=</span> <span class="s">&#39;/srv/django/myproject&#39;</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;test -d </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code_dir</span><span class="p">)</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="n">run</span><span class="p">(</span><span class="s">&quot;git clone user@vcshost:/path/to/repo/.git </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">code_dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">code_dir</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&quot;git pull&quot;</span><span class="p">)</span>
        <span class="n">run</span><span class="p">(</span><span class="s">&quot;touch app.wsgi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>这个 fabfile 使用了 Fabric 的相当一大部分特性集：</p>
<ul class="simple">
<li>定义 fabfile 任务，并用 <a class="reference internal" href="usage/fab.html"><em>fab</em></a> 运行；</li>
<li>用 <cite>~fabric.operations.local</cite> 调用本地 Shell 命令；</li>
<li>用 <cite>~fabric.context_managers.settings</cite> 修改环境变量；</li>
<li>处理命令故障、提示用户及手工取消；</li>
<li>还有定义主机列表和以 <cite>~fabric.operations.run</cite> 运行远程命令。</li>
</ul>
<p>然而，还有更多内容没有在这里覆盖。你还可以看看所有“参见”中提供的链接，和文档内容 <a class="reference internal" href="index.html"><em>索引</em></a> 表。</p>
<p>能看到这里真不容易，谢谢！</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">概览与入门</a><ul>
<li><a class="reference internal" href="#fabric">Fabric 是什么？</a></li>
<li><a class="reference internal" href="#fab">你好， <tt class="docutils literal"><span class="pre">fab</span></tt></a></li>
<li><a class="reference internal" href="#id2">任务参数</a></li>
<li><a class="reference internal" href="#id3">本地命令</a></li>
<li><a class="reference internal" href="#id4">用你的方式来组织</a></li>
<li><a class="reference internal" href="#id5">故障</a><ul>
<li><a class="reference internal" href="#id6">故障处理</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">建立连接</a><ul>
<li><a class="reference internal" href="#id8">远程交互</a></li>
<li><a class="reference internal" href="#defining-connections">预先定义连接</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10">小结</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">欢迎访问 Fabric 中文版文档！</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="usage/env.html"
                        title="next chapter">The environment dictionary, <tt class="docutils literal"><span class="pre">env</span></tt></a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/tutorial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="usage/env.html" title="The environment dictionary, env"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="欢迎访问 Fabric 中文版文档！"
             >previous</a> |</li>
        <li><a href="index.html">Fabric-docs-cn 1.8 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Felix.Lu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>